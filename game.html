<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Záhada Černé Barbory - S Inventářem</title>
    <!-- Načtení Font Awesome pro ikony -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Nový Gotický/Viktoriánský Font */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
    </style>
</head>
<body>

    <div class="game-container">
        <h1>Záhada Černé Barbory</h1>
        <div id="viewport">
            <div class="loading-overlay" id="loading-overlay">Čekání na osud...</div>
            <div class="direction-label" id="direction-label"></div>
            <div class="area-label" id="area-label"></div>
        </div>

        <div class="controls-row">
            <button class="control-button" id="turn-left" onclick="turnLeft()">
                <i class="fas fa-hand-point-left"></i> Otočit vlevo
            </button>
            <button class="control-button" id="move-forward" onclick="moveForward()">
                <i class="fas fa-feather-alt"></i> Vpřed
            </button>
            <button class="control-button" id="turn-right" onclick="turnRight()">
                Otočit vpravo <i class="fas fa-hand-point-right"></i>
            </button>
        </div>
        <p class="instruction-text">Prozkoumejte své okolí a hledejte stopy. Váš inventář je níže.</p>

        <!-- Nový Inventář UI -->
        <div id="inventory-display">
            <!-- Sem se dynamicky přidávají předměty -->
        </div>
        
    </div>

    <!-- Modaly -->
    <div class="modal-backdrop" id="text-modal-backdrop">
        <div id="item-popup" class="popup-window">
            <p id="popup-text"></p>
            <button class="control-button" id="close-popup" onclick="hidePopup('text-modal-backdrop')">Zavřít</button>
        </div>
    </div>

    <div class="modal-backdrop" id="puzzle-modal-backdrop">
        <div id="input-puzzle-modal" class="popup-window">
            <h2>Hádanka Erbové Pečetě</h2>
            <p>Zadejte klíčová slova v pořadí, v jakém byla nalezena, abyste odemkli průchod.</p>
            <div class="puzzle-input-group">
                <label for="symbol1">Symbol 1 (Pod Štandlem - Hrob):</label>
                <input type="text" id="symbol1" maxlength="5">
                
                <label for="symbol2">Symbol 2 (Místecká Kašna):</label>
                <input type="text" id="symbol2" maxlength="5">
                
                <label for="symbol3">Symbol 3 (Kostel Sv. Jošta):</label>
                <input type="text" id="symbol3" maxlength="4">
                
                <label for="symbol4">Symbol 4 (Frýdecký Zámek):</label>
                <input type="text" id="symbol4" maxlength="6">
            </div>
            <button id="solve-puzzle-button" onclick="solvePuzzle()">Odemknout</button>
        </div>
    </div>
    <!-- Konec Modalů -->

    <script>
        // --- MAPA HRY A STAV ---
        
        const VIEWPORT_WIDTH = 800;
        const VIEWPORT_HEIGHT = 600;

        // Definice předmětů v inventáři pro snazší správu (id, jméno, ikona)
        const INVENTORY_ITEMS = {
            'papirek_cerny_klic': { name: 'Papírek se Symbolem', icon: 'fa-scroll', tooltip: 'Papírek s nápisem: "Černý Klíč". Je to první symbol hádanky: KLIC.' },
            'cerny_klic': { name: 'Černý Klíč', icon: 'fa-key', tooltip: 'Starý, nečistitelný klíč nalezený v hrobě. Odemkne erb.' },
            'ctyrlistek': { name: 'Rytina Čtyřlístku', icon: 'fa-leaf', tooltip: 'Stopa z kašny. Druhý symbol hádanky: LIST.' },
            'kriz_z_hrobu': { name: 'Kříž z Hrobu', icon: 'fa-cross', tooltip: 'Stopa z Jošta. Třetí symbol hádanky: KRIZ.' },
            'slechticka_pecet': { name: 'Šlechtická Pečeť', icon: 'fa-stamp', tooltip: 'Stopa ze zámku. Čtvrtý symbol hádanky: PECET.' }
        };

        const MAP = {
            "UpatíŠtandlu": {
                name: "Úpatí Štandlu",
                N: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/363025/d0c6ac?text=Cesta+nahoru+na+Standl`, 
                    forward: "ŠtandlVrchol",
                    items: [
                        { x: 380, y: 520, text: "Cesta pokračuje nahoru k vrcholu. Je strmá a plná stínů.", type: 'text' },
                    ]
                },
                E: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/363025/d0c6ac?text=Hustý+les+a+mlha` },
                S: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/363025/d0c6ac?text=Skrytá+cesta+k+Hrobu`,
                    forward: "UHrobu",
                    items: [
                        { x: 150, y: 400, text: "Zde je odbočka, stará stezka vedoucí hlouběji do lesa. Cítíte chlad.", type: 'text' }
                    ]
                },
                W: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/363025/d0c6ac?text=Bažinatá+místa` },
            },
            "UHrobu": {
                name: "U Hrobu (Pod Štandlem)",
                N: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/4d261e/d0c6ac?text=Místo+starého+hrobu`,
                    forward: "UpatíŠtandlu",
                    items: [
                        { x: 450, y: 550, text: "Hrob je rozpadlý a vlhký. Mezi kameny nacházíte starý, zažloutlý papírek. ***Získali jste Papírek se Symbolem Černého Klíče.*** (Symbol 1: KLIC)", itemKey: 'papirek_cerny_klic', type: 'item' },
                    ]
                },
                E: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/4d261e/d0c6ac?text=Temná+strana+kopce` },
                S: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/4d261e/d0c6ac?text=Není+cesty` },
                W: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/4d261e/d0c6ac?text=Není+cesty` },
            },
            "ŠtandlVrchol": {
                name: "Štandl Vrchol (Popraviště)",
                N: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/4d261e/d0c6ac?text=Vyhlídka+na+krajinu`, 
                    items: [
                        { x: 600, y: 200, text: "Zbytek hrubého lana. Barbořina kletba se váže na krev a provaz.", type: 'text' }
                    ]
                },
                E: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/4d261e/d0c6ac?text=Pohled+na+Místek`,
                    forward: "MístekNáměstí" 
                },
                S: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/4d261e/d0c6ac?text=Cesta+zpět+k+úpatí`, 
                    forward: "UpatíŠtandlu"
                },
                W: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/4d261e/d0c6ac?text=Kamenný+Erb+na+západní+straně`,
                    forward: "ŠtandlUErbu",
                    items: [
                        { x: 100, y: 400, text: "Starý kamenný erb je na zdi. Zdá se být klíčovým místem.", type: 'text' }
                    ]
                },
            },
            "ŠtandlUErbu": {
                name: "Štandl: U Erbu",
                N: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/20201a/d0c6ac?text=Masivní+Kamenný+Erb`,
                    forward: "ŠtandlVrchol", // Defaultní cesta zpět
                    items: [
                        { x: 400, y: 300, text: "Kamenný Erb s otvory na symboly.", type: 'puzzle' }
                    ]
                },
                E: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/20201a/d0c6ac?text=Les+a+skály` },
                S: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/20201a/d0c6ac?text=Les+a+skály` },
                W: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/20201a/d0c6ac?text=Cesta+zpět+na+vrchol`,
                    forward: "ŠtandlVrchol"
                },
            },
            "Jeskyně": {
                name: "Jeskyně Černé Barbory (FINÁLE)",
                N: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/000000/d0c6ac?text=KOSTRA+A+POKLAD+ATTILY`,
                    items: [
                        { x: 400, y: 300, text: "Našli jste kostru Černé Barbory, která v náručí svírá bednu. Uvnitř bedny je poklad, Attilův meč a Barbořina kletba je zlomena. **Gratulujeme, vyřešili jste Záhadu Černé Barbory!**", type: 'text' }
                    ]
                },
                E: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/000000/d0c6ac?text=Tma` },
                S: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/000000/d0c6ac?text=Vstup+do+jeskyně`,
                    forward: "ŠtandlUErbu"
                },
                W: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/000000/d0c6ac?text=Tma` },
            },
            "MístekNáměstí": {
                name: "Místek Náměstí",
                N: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/1a202c/d0c6ac?text=Budovy+a+radnice` },
                E: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/1a202c/d0c6ac?text=Most+přes+Ostravici`, 
                    forward: "FrýdeckýZámek",
                    items: [
                        { x: 550, y: 480, text: "Voda je ledová. Na okraji kašny je sotva viditelná rytina symbolu, který připomíná **ČTYŘLÍSTEK**. ***Získali jste stopu LIST.*** (Symbol 2)", itemKey: 'ctyrlistek', type: 'item' }
                    ]
                },
                S: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/1a202c/d0c6ac?text=Cesta+ke+kostelu+Sv.+Jošta`,
                    forward: "KostelSvJosta",
                    items: [
                        { x: 200, y: 450, text: "Na informační tabuli vidíte zmínku o tom, že se Barbora modlila u nedalekého kostela Sv. Jošta.", type: 'text' }
                    ]
                },
                W: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/1a202c/d0c6ac?text=Směr+zpět+ke+Štandlu`,
                    forward: "ŠtandlVrchol"
                },
            },
            "KostelSvJosta": {
                name: "Kostel Sv. Jošta",
                N: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/1a202c/d0c6ac?text=Vchod+do+kostela`, 
                    forward: "MístekNáměstí"
                },
                E: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/1a202c/d0c6ac?text=Kostelní+hřbitov` },
                S: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/1a202c/d0c6ac?text=Staré+hroby+za+kostelem`, 
                    items: [
                        { x: 300, y: 400, text: "Jeden ze starých náhrobků má neobvykle velký, kovový kříž. Je na něm vytesáno slovo: **KRIZ**. ***Získali jste stopu Kříž z Hrobu.*** (Symbol 3)", itemKey: 'kriz_z_hrobu', type: 'item' }
                    ]
                },
                W: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/1a202c/d0c6ac?text=Kostelní+zeď` },
            },
            "FrýdeckýZámek": {
                name: "Frýdecký Zámek",
                N: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/20201a/d0c6ac?text=Čelní+pohled+na+hrad`,
                    items: [
                        { x: 400, y: 450, text: "Těžká dřevěná brána. Na jedné straně je vytesaný symbol, který připomíná **PEČEŤ**. ***Získali jste stopu Šlechtická Pečeť.*** (Symbol 4)", itemKey: 'slechticka_pecet', type: 'item' }
                    ]
                },
                E: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/20201a/d0c6ac?text=Východní+křídlo+zámku` },
                S: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/20201a/d0c6ac?text=Nádvoří+s+osobou`, 
                    forward: "UPolaska",
                    items: [
                        { x: 500, y: 400, text: "Na nádvoří se toulá starý hlídač. Vypadá, že má času nazbyt. Zkuste s ním promluvit.", type: 'text' }
                    ]
                },
                W: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/20201a/d0c6ac?text=Cesta+zpět+k+mostu`, 
                    forward: "MístekNáměstí" 
                },
            },
            "UPolaska": {
                name: "U Poláška (Strážce Zámku)",
                N: { 
                    img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/20201a/d0c6ac?text=Polášek+stojí+u+kašny`, 
                    forward: "FrýdeckýZámek",
                    items: [
                        { x: 400, y: 350, text: "Hlídač se představuje jako Polášek. Zdá se být příjemný. Možná mu ukážete svůj nález.", type: 'npc' }
                    ]
                },
                E: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/20201a/d0c6ac?text=Nádvoří` },
                S: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/20201a/d0c6ac?text=Nádvoří` },
                W: { img: `https://placehold.co/${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}/20201a/d0c6ac?text=Nádvoří` },
            },
        };

        const DIRECTIONS = ['N', 'E', 'S', 'W'];

        let currentArea = "UpatíŠtandlu";
        let currentDirectionIndex = 0; 
        let inventory = []; // Skladuje ID předmětů

        // --- ELEMENTY DOM ---
        const viewport = document.getElementById('viewport');
        const forwardButton = document.getElementById('move-forward');
        const loadingOverlay = document.getElementById('loading-overlay');
        const directionLabel = document.getElementById('direction-label');
        const areaLabel = document.getElementById('area-label');
        const textModalBackdrop = document.getElementById('text-modal-backdrop');
        const puzzleModalBackdrop = document.getElementById('puzzle-modal-backdrop');
        const popupText = document.getElementById('popup-text');
        const inventoryDisplay = document.getElementById('inventory-display');

        // --- INVENTÁŘ A MODALY ---

        /**
         * Zobrazí textové vyskakovací okno.
         * @param {string} text Text k zobrazení.
         */
        function showPopup(text) {
            popupText.innerHTML = text;
            textModalBackdrop.style.display = 'flex';
        }

        /**
         * Skryje vyskakovací okno.
         * @param {string} modalId ID modalu k zavření.
         */
        function hidePopup(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        /**
         * Přidá předmět do inventáře a aktualizuje zobrazení.
         * @param {string} itemId ID předmětu (klíč z INVENTORY_ITEMS).
         */
        function addItem(itemId) {
            if (!inventory.includes(itemId)) {
                inventory.push(itemId);
                updateInventoryDisplay();
                return true; // Předmět byl přidán
            }
            return false; // Předmět již v inventáři je
        }

        /**
         * Odebere předmět z inventáře (pro interakci Poláška).
         * @param {string} itemId ID předmětu.
         */
        function removeItem(itemId) {
            const index = inventory.indexOf(itemId);
            if (index > -1) {
                inventory.splice(index, 1);
                updateInventoryDisplay();
                return true;
            }
            return false;
        }

        /**
         * Aktualizuje zobrazení inventáře.
         */
        function updateInventoryDisplay() {
            inventoryDisplay.innerHTML = '';
            if (inventory.length === 0) {
                inventoryDisplay.innerHTML = '<p style="text-align: center; color: #5a4d3f; font-size: 0.9em;">Inventář je prázdný. Hledejte stopy!</p>';
                return;
            }

            inventory.forEach(itemId => {
                const item = INVENTORY_ITEMS[itemId];
                if (item) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'inventory-item';
                    itemDiv.title = item.tooltip;
                    
                    const icon = document.createElement('i');
                    icon.className = `fas ${item.icon} inventory-icon`;
                    
                    const name = document.createElement('span');
                    name.textContent = item.name.split(' ')[0]; // Zobrazí jen první slovo jména

                    itemDiv.appendChild(icon);
                    itemDiv.appendChild(name);
                    inventoryDisplay.appendChild(itemDiv);
                }
            });
        }

        // --- LOGIKA HOTSPOTŮ ---

        /**
         * Zpracuje kliknutí na hotspot s komplexní logikou.
         * @param {object} item Data hotspotu.
         */
        function handleHotspotClick(item) {
            switch (item.type) {
                case 'item':
                    const added = addItem(item.itemKey);
                    if (added) {
                        showPopup(`${item.text} <br><br> ***Předmět přidán do inventáře.***`);
                    } else {
                        showPopup("Už jste toto místo prozkoumali. " + item.text.replace(/(\*+.*\*+)/g, '')); 
                    }
                    break;
                
                case 'npc':
                    handlePolasekInteraction(item);
                    break;

                case 'puzzle':
                    handlePuzzleInteraction(item);
                    break;

                case 'text':
                default:
                    showPopup(item.text);
                    break;
            }
        }

        /**
         * Speciální logika pro Poláška (NPC).
         */
        function handlePolasekInteraction(item) {
            if (inventory.includes('papirek_cerny_klic')) {
                removeItem('papirek_cerny_klic');
                addItem('cerny_klic');
                showPopup("Polášek: 'Aha! Ten papírek... to sedí! Před lety jsem našel v tom hrobě starý klíč. Nikdy jsem ho nemohl vyčistit. Zdá se, že teď je váš. Je to **Černý Klíč**.'<br><br>***Vyměnili jste Papírek za Černý Klíč!***");
            } else if (inventory.includes('cerny_klic')) {
                 showPopup("Polášek: 'Máte, co potřebujete. Někde u starého popraviště je erb, na který by klíč mohl pasovat...'");
            } else {
                showPopup("Polášek: 'Jsem jen starý strážce. Nic zvláštního tu neuvidíte. Ale les kolem Štandlu je prý plný starých tajemství.'");
            }
        }

        /**
         * Logika pro spuštění hádanky.
         */
        function handlePuzzleInteraction(item) {
            if (currentArea === 'ŠtandlUErbu' && inventory.includes('cerny_klic')) {
                // Hádanka u Erbu
                puzzleModalBackdrop.style.display = 'flex';
            } else if (currentArea === 'ŠtandlUErbu' && !inventory.includes('cerny_klic')) {
                showPopup("Kamenný erb je na pohled masivní. V prohlubni je vidět otvor ve tvaru klíče. K jeho aktivaci potřebujete **Černý Klíč**.");
            } else {
                showPopup(item.text);
            }
        }
        
        /**
         * Zpracuje řešení hádanky.
         */
        window.solvePuzzle = function() {
            const sym1 = document.getElementById('symbol1').value.toUpperCase();
            const sym2 = document.getElementById('symbol2').value.toUpperCase();
            const sym3 = document.getElementById('symbol3').value.toUpperCase();
            const sym4 = document.getElementById('symbol4').value.toUpperCase();

            // Správné řešení: KLIC, LIST, KRIZ, PEČET
            if (sym1 === 'KLIC' && sym2 === 'LIST' && sym3 === 'KRIZ' && sym4 === 'PECET') {
                
                // Otevření nové cesty do Jeskyně
                MAP['ŠtandlUErbu']['N'].forward = 'Jeskyně';

                hidePopup('puzzle-modal-backdrop');
                showPopup('Mechanismus zaskřípe a s hlasitým duněním se v zemi otevře propadliště. **Cesta do Jeskyně Černé Barbory je volná!** Nyní se musíte otočit na Sever a jít Vpřed.');
                
                // Zrušení hádanky, už není potřeba
                const puzzleHotspot = MAP['ŠtandlUErbu']['N'].items.find(i => i.type === 'puzzle');
                if(puzzleHotspot) puzzleHotspot.text = "Vstup do jeskyně je nyní otevřen.";
                
                updateView();

            } else {
                showPopup('Erb se nehnul. Chybí vám symbol, nebo je špatné pořadí. Zkuste to znovu.');
            }
        }


        // --- VYKRESLENÍ POHLEDU ---

        function renderHotspots() {
            // Odebere všechny prvky, které nejsou overlay nebo popisky
            const removableElements = Array.from(viewport.children).filter(el => 
                !el.classList.contains('loading-overlay') && 
                !el.classList.contains('direction-label') &&
                !el.classList.contains('area-label')
            );
            removableElements.forEach(el => el.remove());

            const currentDir = DIRECTIONS[currentDirectionIndex];
            const viewData = MAP[currentArea][currentDir];

            if (viewData.items && viewData.items.length > 0) {
                viewData.items.forEach(item => {
                    const hotspot = document.createElement('div');
                    hotspot.className = 'hotspot';
                    // Hotspoty se umisťují relativně k viewportu
                    hotspot.style.left = `${item.x / VIEWPORT_WIDTH * 100}%`;
                    hotspot.style.top = `${item.y / VIEWPORT_HEIGHT * 100}%`;
                    hotspot.title = "Prozkoumat"; 
                    // Nastavení volání handleHotspotClick
                    hotspot.onclick = () => handleHotspotClick(item);
                    viewport.appendChild(hotspot);
                });
            }
        }

        function updateView() {
            const currentDir = DIRECTIONS[currentDirectionIndex];
            const areaData = MAP[currentArea];
            const viewData = areaData[currentDir];

            // 1. Zobrazení indikátoru načítání
            loadingOverlay.style.display = 'flex';
            viewport.style.backgroundImage = 'none';

            // 2. Přednačtení obrázku
            const img = new Image();
            img.onload = () => {
                viewport.style.backgroundImage = `url('${viewData.img}')`;
                loadingOverlay.style.display = 'none';
                
                // 3. Aktualizace popisků
                directionLabel.textContent = `Směr: ${currentDir}`;
                areaLabel.textContent = `Oblast: ${areaData.name}`;

                // 4. Aktualizace stavu tlačítka Vpřed
                if (viewData.forward) {
                    forwardButton.disabled = false;
                    forwardButton.title = `Pokračovat do ${MAP[viewData.forward].name}`;
                    forwardButton.textContent = 'Vpřed';
                } else {
                    forwardButton.disabled = true;
                    forwardButton.title = "Zde není žádná cesta. Musíte se otočit.";
                    forwardButton.textContent = 'Blokováno';
                }

                // 5. Vykreslení Hotspotů a Inventáře
                renderHotspots();
                updateInventoryDisplay();
            };

            img.onerror = () => {
                // Přesměrování na placeholder v případě chyby načítání
                viewport.style.backgroundImage = `url('https://placehold.co/800x600/600000/ffffff?text=CHYBA+NAČÍTÁNÍ+OBRÁZKU')`;
                loadingOverlay.style.display = 'none';
                directionLabel.textContent = `Směr: ${currentDir}`;
                areaLabel.textContent = `Oblast: ${areaData.name} (Temnota pohltila obraz!)`;
                forwardButton.disabled = true;
                renderHotspots(); 
            };

            img.src = viewData.img;
        }

        // --- POHYBOVÉ FUNKCE ---
        window.turnLeft = function() {
            currentDirectionIndex = (currentDirectionIndex - 1 + DIRECTIONS.length) % DIRECTIONS.length;
            updateView();
        }

        window.turnRight = function() {
            currentDirectionIndex = (currentDirectionIndex + 1) % DIRECTIONS.length;
            updateView();
        }

        window.moveForward = function() {
            const currentDir = DIRECTIONS[currentDirectionIndex];
            const viewData = MAP[currentArea][currentDir];

            if (viewData.forward) {
                currentArea = viewData.forward;
                updateView();
            } else {
                showPopup("Nelze pokračovat vpřed. Cesta je zapečetěna, nebo je blokovaná.");
            }
        }

        // --- INICIALIZACE ---
        window.onload = function() {
            // Nastavíme rozměry pro správné umístění hotspotů (pokud by se rozměry lišily od placeholderu)
            // Pro responsivitu je lepší používat procenta, ale pro konzistenci zachováme tuto logiku pro umístění
            updateView();
        };

    </script>
</body>
</html>